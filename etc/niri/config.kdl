#!/usr/bin/env bash
set -euo pipefail

echo "=== Arch Bootstrap ==="

# 0. User input
read -p "AMD or Intel Ucode? [amd/intel]: " ucode_choice
read -p "Install Vulkan? [intel/amd/no]: " vulkan_choice
read -p "Use Fish shell? [y/N]: " fish_choice
read -p "Install Discord? [y/N]: " discord_choice
read -p "PNG or GIF wallpaper? [png/gif/none]: " wallpaper_choice

USER_NAME="$(id -un)"
USER_HOME="$(getent passwd "$USER_NAME" | cut -d: -f6)"

# 1. Core tools
sudo pacman -Syu --needed --noconfirm base-devel git rsync

# 2. Clone repo
REPO_URL="https://github.com/callmekevink/archbootstrap"
CLONE_DIR="$USER_HOME/arch-setup"
rm -rf "$CLONE_DIR"
git clone "$REPO_URL" "$CLONE_DIR"
cd "$CLONE_DIR"

# 3. Microcode
case "$ucode_choice" in
  amd) sudo pacman -S --needed --noconfirm amd-ucode ;;
  intel) sudo pacman -S --needed --noconfirm intel-ucode ;;
esac

# 4. Vulkan
case "$vulkan_choice" in
  intel)
    sudo pacman -S --needed --noconfirm vulkan-intel vulkan-icd-loader
    ;;
  amd)
    sudo pacman -R --noconfirm amdvlk || true
    sudo pacman -S --needed --noconfirm vulkan-radeon vulkan-icd-loader
    ;;
esac

# 5. Optional packages
[[ "$discord_choice" =~ ^[Yy]$ ]] && sudo pacman -S --needed --noconfirm discord

sudo mkinitcpio -P

# 6. yay
if ! command -v yay &>/dev/null; then
    tmpdir="$(mktemp -d)"
    git clone https://aur.archlinux.org/yay.git "$tmpdir/yay"
    pushd "$tmpdir/yay" >/dev/null
    makepkg -si --noconfirm
    popd >/dev/null
    rm -rf "$tmpdir"
fi

# 7. Package lists
[ -f packages/pacman.txt ] && sudo pacman -S --needed --noconfirm - < packages/pacman.txt
[ -f packages/aur.txt ] && yay -S --needed --noconfirm - < packages/aur.txt

# 8. Deploy files
[ -d etc ] && sudo rsync -a etc/ /etc/
[ -d usr ] && sudo rsync -a usr/ /usr/
[ -d home ] && rsync -a home/ "$USER_HOME/"

# 9. Caches
[ -d "$USER_HOME/.local/share/fonts" ] && fc-cache -fv >/dev/null
[ -d "$USER_HOME/.local/share/applications" ] && \
  update-desktop-database "$USER_HOME/.local/share/applications"

# 10. Wallpaper (niri global config + awww)
if command -v awww &>/dev/null; then
    WALLPAPER_DIR="$USER_HOME/.local/share/wallpapers"
    mkdir -p "$WALLPAPER_DIR"

    case "$wallpaper_choice" in
      png) WALLPAPER="$WALLPAPER_DIR/Hades.png" ;;
      gif) WALLPAPER="$WALLPAPER_DIR/8bitCity.gif" ;;
      *) WALLPAPER="" ;;
    esac

    if [[ -n "$WALLPAPER" ]]; then
        sudo install -d /etc/niri

        sudo tee /etc/niri/wallpaper.kdl >/dev/null <<EOF
spawn-at-startup "awww-daemon"
spawn-at-startup "awww" "img" "$WALLPAPER"
EOF

        if ! grep -q 'include "wallpaper.kdl"' /etc/niri/config.kdl; then
            echo 'include "wallpaper.kdl"' | sudo tee -a /etc/niri/config.kdl >/dev/null
        fi
    fi
fi

# 11. Display manager (ly)
if pacman -Qs ly >/dev/null; then
    sudo systemctl enable ly@tty2.service
    sudo systemctl disable getty@tty2.service || true
fi

# 12. dark pref
gsettings set org.gnome.desktop.interface color-scheme 'prefer-dark' || true

# 13. Fish
if [[ "$fish_choice" =~ ^[Yy]$ ]]; then
    sudo pacman -S --needed --noconfirm fish
    sudo chsh -s /usr/bin/fish "$USER_NAME"
fi

# 14. Cleanup
cd "$USER_HOME"
rm -rf "$CLONE_DIR"

echo "Done."

read -p "Reboot now? [y/N]: " reboot_confirm
[[ "$reboot_confirm" =~ ^[Yy]$ ]] && sudo reboot || echo "Reboot recommended."
